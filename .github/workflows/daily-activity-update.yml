name: Daily Activity Update

on:
  schedule:
    # Run daily at 9 AM EST (14:00 UTC)
    - cron: '0 14 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing

jobs:
  update-activity:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch yesterday's commits and ingest
        run: |
          USERNAME="musselmanjoey"

          # Calculate cutoff time (36 hours ago)
          CUTOFF=$(date -u -d '36 hours ago' +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff time: $CUTOFF"

          # Get list of public repos
          echo "Fetching public repos..."
          REPOS=$(curl -s "https://api.github.com/users/$USERNAME/repos?per_page=100&type=public" | jq -r '.[].full_name')

          ALL_COMMITS="[]"

          # Fetch recent commits from each repo
          for REPO in $REPOS; do
            echo "Checking $REPO..."
            REPO_COMMITS=$(curl -s "https://api.github.com/repos/$REPO/commits?since=$CUTOFF&per_page=50" | jq --arg repo "$REPO" '[
              .[] |
              select(.commit != null) |
              {
                sha: .sha,
                repo: $repo,
                message: .commit.message,
                committed_at: .commit.author.date,
                url: .html_url
              }
            ]' 2>/dev/null || echo "[]")

            COUNT=$(echo "$REPO_COMMITS" | jq 'length')
            if [ "$COUNT" -gt "0" ]; then
              echo "  Found $COUNT commits"
              ALL_COMMITS=$(echo "$ALL_COMMITS $REPO_COMMITS" | jq -s 'add')
            fi
          done

          COMMIT_COUNT=$(echo "$ALL_COMMITS" | jq 'length')
          echo ""
          echo "Total commits found: $COMMIT_COUNT"

          if [ "$COMMIT_COUNT" -eq "0" ]; then
            echo "No new commits to ingest"
            exit 0
          fi

          echo "Sample commits:"
          echo "$ALL_COMMITS" | jq '.[0:3]'

          # POST to the commits API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.SITE_URL }}/api/commits" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.UPDATE_SECRET }}" \
            -d "{\"commits\": $ALL_COMMITS}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Failed to ingest commits"
            exit 1
          fi

          echo "Commits ingested successfully!"
